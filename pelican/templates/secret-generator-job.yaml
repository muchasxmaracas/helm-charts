# 1. Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "pelican.fullname" . }}-secret-mgr
  annotations:
    "argocd.argoproj.io/hook": PreSync
    "argocd.argoproj.io/sync-wave": "0"
---
# 2. Role (Added 'patch' and 'update' for safety)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "pelican.fullname" . }}-secret-mgr-role
  annotations:
    "argocd.argoproj.io/hook": PreSync
    "argocd.argoproj.io/sync-wave": "0"
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "list", "patch", "update"]
---
# 3. Role Binding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "pelican.fullname" . }}-secret-mgr-binding
  annotations:
    "argocd.argoproj.io/hook": PreSync
    "argocd.argoproj.io/sync-wave": "0"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "pelican.fullname" . }}-secret-mgr-role
subjects:
- kind: ServiceAccount
  name: {{ include "pelican.fullname" . }}-secret-mgr
  namespace: {{ .Release.Namespace }}
---
# 4. The Generation Job (Fixed syntax and added Sync-Wave)
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "pelican.fullname" . }}-secret-gen
  annotations:
    "argocd.argoproj.io/hook": PreSync
    "argocd.argoproj.io/sync-wave": "1" # Runs after RBAC is ready
    "argocd.argoproj.io/hook-delete-policy": BeforeHookCreation
spec:
  template:
    spec:
      serviceAccountName: {{ include "pelican.fullname" . }}-secret-mgr
      restartPolicy: OnFailure
      containers:
      - name: generate
        image: bitnami/kubectl:latest
        command:
        - /bin/sh
        - -c
        - |
          # Check if APP_KEY exists
          EXISTING_KEY=$(kubectl get secret mysql-config -n {{ .Release.Namespace }} -o jsonpath='{.data.APP_KEY}' 2>/dev/null)

          if [ -z "$EXISTING_KEY" ]; then
            echo "Secret or APP_KEY missing. Generating..."
            
            USER_PASS=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 24)
            ROOT_PASS=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 24)
            APP_KEY="base64:$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 32 | base64)"
            
            # The 'apply -f -' fix is here:
            kubectl create secret generic mysql-config \
              --from-literal=MARIADB_USER={{ .Values.database.config.user | default "pelican" }} \
              --from-literal=MARIADB_PASSWORD=$USER_PASS \
              --from-literal=DB_PASSWORD=$USER_PASS \
              --from-literal=MARIADB_ROOT_PASSWORD=$ROOT_PASS \
              --from-literal=MARIADB_DATABASE={{ .Values.database.config.database | default "pelican" }} \
              --from-literal=APP_KEY=$APP_KEY \
              -n {{ .Release.Namespace }} \
              --dry-run=client -o yaml | kubectl apply -f -
            
            echo "Success: mysql-config created."
          else
            echo "Success: mysql-config already exists with APP_KEY."
          fi