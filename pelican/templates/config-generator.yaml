apiVersion: batch/v1
kind: Job
metadata:
  name: pelican-config-generator
  namespace: pelican
spec:
  ttlSecondsAfterFinished: 100
  template:
    spec:
      serviceAccountName: pelican-config-sa
      containers:
      - name: generator
        image: alpine:3.20
        command:
        - "/bin/sh"
        - "-c"
        - |
          # 1. Install the exact tools we need
          apk add --no-cache curl jq

          # 2. Install kubectl (Alpine version)
          curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x ./kubectl
          mv ./kubectl /usr/local/bin/kubectl

          NODE_ID="2"
          echo "Fetching config for Node ID: $NODE_ID..."
          
          # 3. Fetch from the Application API
          CONFIG=$(curl -s -X GET "$PANEL_URL/api/application/nodes/$NODE_ID/configuration" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Accept: application/json")

          if echo "$CONFIG" | grep -q "errors" || [ -z "$CONFIG" ]; then
            echo "FAILED! Response from Panel:"
            echo "$CONFIG"
            exit 1
          fi

          # 4. Apply overrides
          FINAL_CONFIG=$(echo "$CONFIG" | jq '.api.ssl.enabled=false | .system.docker.host="tcp://127.0.0.1:2375" | .remote="http://game.baphomet.cloud"')
          
          # 5. Patch the Secret
          echo "$FINAL_CONFIG" > /tmp/config.yml
          kubectl create secret generic wings-config \
            --from-file=config.yml=/tmp/config.yml \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "REAL SUCCESS: Secret 'wings-config' updated."
        env:
        - name: PANEL_URL
          value: "https://game.baphomet.cloud"
        - name: API_TOKEN
          valueFrom:
            secretKeyRef:
              name: pelican-api-token
              key: token
      restartPolicy: OnFailure